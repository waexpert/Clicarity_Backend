# Migration System Files Overview

## ğŸ“ File Structure (Clean & Organized)

### **Core Service** (1 file)
```
controllers/services/
â””â”€â”€ migrationService.js          # Main migration logic & tracking
```

### **CLI Scripts** (6 files)
```
scripts/
â”œâ”€â”€ migrate-tenants.js           # Deploy migrations to tenants
â”œâ”€â”€ migration-status.js          # Check migration status
â”œâ”€â”€ backfill-schemas.js          # Backfill missing tables
â”œâ”€â”€ rollback-migration.js        # Rollback migrations
â”œâ”€â”€ verify-schemas.js            # Health check all schemas
â””â”€â”€ test-migration-flow.js       # Demo/test script
```

### **Migration Files** (Generated by Prisma)
```
prisma/
â””â”€â”€ migrations/
    â””â”€â”€ YYYYMMDD_name/
        â”œâ”€â”€ migration.sql        # Up migration (auto-generated)
        â””â”€â”€ rollback.sql         # Down migration (manual, optional)
```

---

## ğŸ¯ What Each File Does

### **migrationService.js**
The brain of the migration system.

**Key Functions**:
- `applyAllPendingMigrations()` - Apply new migrations
- `rollbackMigration()` - Revert migrations
- `backfillRequiredTables()` - Ensure all 4 required tables exist
- `getMigrationStatus()` - Check what's applied/pending
- `migrateAllTenants()` - Batch migrate all tenants

**Used by**: All CLI scripts and TenantService

---

### **migrate-tenants.js**
Deploy migrations to tenant schemas.

**Usage**:
```bash
npm run migration:deploy-all           # All tenants
npm run migration:deploy <schema>      # Specific tenant
```

**What it does**:
1. Finds all tenant schemas
2. Checks pending migrations
3. Applies migrations in transaction
4. Reports success/failure

---

### **migration-status.js**
Check migration status for schemas.

**Usage**:
```bash
npm run migration:status               # All tenants
npm run migration:status <schema>      # Specific tenant
```

**Output**:
- Applied vs pending migrations
- Required tables status
- Overall health indicator

---

### **backfill-schemas.js**
Ensure all schemas have the 4 required tables.

**Usage**:
```bash
npm run migration:backfill
```

**What it does**:
- Checks each schema for missing tables
- Creates missing tables from initial migration
- Reports what was backfilled

**Required Tables**:
- team_member
- vendor
- contact
- reminders

---

### **rollback-migration.js**
Revert a migration (requires rollback.sql).

**Usage**:
```bash
npm run migration:rollback <version>            # All tenants
npm run migration:rollback <version> <schema>   # Specific tenant
```

**Example**:
```bash
npm run migration:rollback 20241220_add_field
```

---

### **verify-schemas.js**
Health check for all tenant schemas.

**Usage**:
```bash
npm run migration:verify
```

**Checks**:
- All required tables present
- Migration tracking table exists
- Schema structure consistency

---

### **test-migration-flow.js**
Demo script showing how migrations work.

**Usage**:
```bash
npm run migration:demo
```

**Shows**:
- Current migration status
- How old vs new users are handled
- Example workflow

---

## ğŸ”„ Typical Workflow

### **Making Schema Changes**

1. Edit `prisma/schema.prisma`
2. Create migration:
   ```bash
   npm run migration:create my_feature
   ```
3. Check status:
   ```bash
   npm run migration:status
   ```
4. Deploy:
   ```bash
   npm run migration:deploy-all
   ```
5. Verify:
   ```bash
   npm run migration:verify
   ```

### **Fixing Existing Schemas**

If schemas are missing tables:
```bash
npm run migration:backfill
```

### **Rolling Back**

If a migration causes issues:
```bash
npm run migration:rollback <version>
```

---

## ğŸ“¦ Package.json Commands

All migration commands are in [package.json](package.json):

```json
{
  "scripts": {
    "migration:create": "npx prisma migrate dev --name",
    "migration:status": "node scripts/migration-status.js",
    "migration:deploy": "node scripts/migrate-tenants.js",
    "migration:deploy-all": "node scripts/migrate-tenants.js",
    "migration:backfill": "node scripts/backfill-schemas.js",
    "migration:rollback": "node scripts/rollback-migration.js",
    "migration:verify": "node scripts/verify-schemas.js",
    "migration:demo": "node scripts/test-migration-flow.js"
  }
}
```

---

## ğŸ—‘ï¸ Files Removed (Cleanup)

These old files were removed to reduce confusion:

- âŒ `scripts/create-initial-migration.js` - Validation script (no longer needed)
- âŒ `scripts/migrate-all-tenants.js` - Duplicate of migrate-tenants.js
- âŒ `database/migrations/migrationRunner.js` - Empty placeholder

---

## ğŸ“ Integration Points

### **TenantService Integration**

[tenantService.js](controllers/services/tenantService.js) uses migrationService:

```javascript
const migrationService = require('./migrationService');

// During schema creation
await migrationService.ensureMigrationsTable(schemaName, client);
await migrationService.applyAllPendingMigrations(schemaName, client);
await migrationService.backfillRequiredTables(schemaName, client);
```

### **User Registration Integration**

[userController.js](controllers/userController.js) uses TenantService:

```javascript
const tenantService = require('./services/tenantService');

// During registration
await tenantService.createTenantSchema(schemaName, userData);
// This automatically applies all migrations!
```

---

## ğŸ“š Documentation

- [MIGRATION_GUIDE.md](MIGRATION_GUIDE.md) - Full documentation
- [MIGRATIONS_QUICKSTART.md](MIGRATIONS_QUICKSTART.md) - Quick reference
- [MIGRATION_FILES_OVERVIEW.md](MIGRATION_FILES_OVERVIEW.md) - This file

---

## âœ… Summary

**6 CLI scripts** handle all migration operations
**1 core service** provides the migration logic
**All integrated** with your existing TenantService and registration flow
**Clean structure** with no duplicate or obsolete files

Everything you need, nothing you don't! ğŸ‰
